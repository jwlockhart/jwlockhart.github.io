
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://jwlockhart.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://jwlockhart.github.io/theme/pygments/perldoc.min.css">
  <link rel="stylesheet" type="text/css" href="https://jwlockhart.github.io/theme/font-awesome/css/font-awesome.min.css">




    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63759024-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Jeffrey W. Lockhart" />
<meta name="description" content="The title of this post is a bit silly, but the situation is relatively common. In most programming languages1, there are multiple ways to accomplish any task, even the simple ones. These solutions are not all created equal, so if your code is slow, it really pays to test …" />
<meta name="keywords" content="tips, CSS">

<meta property="og:site_name" content="Jeff Lockhart"/>
<meta property="og:title" content="How to make your code 5000x faster, without really trying"/>
<meta property="og:description" content="The title of this post is a bit silly, but the situation is relatively common. In most programming languages1, there are multiple ways to accomplish any task, even the simple ones. These solutions are not all created equal, so if your code is slow, it really pays to test …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jwlockhart.github.io/5000x.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-02-24 18:03:00-05:00"/>
<meta property="article:modified_time" content="2019-02-24 18:03:00-05:00"/>
<meta property="article:author" content="https://jwlockhart.github.io/author/jeffrey-w-lockhart.html">
<meta property="article:section" content="tips"/>
<meta property="article:tag" content="tips"/>
<meta property="article:tag" content="CSS"/>
<meta property="og:image" content="/images/face.jpg">

  <title>Jeff Lockhart &ndash; How to make your code 5000x faster, without really trying</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://jwlockhart.github.io">
        <img src="/images/face.jpg" alt="Jeff Lockhart" title="Jeff Lockhart">
      </a>
      <h1><a href="https://jwlockhart.github.io">Jeff Lockhart</a></h1>


      <nav>
        <ul class="list">
          <li><a href="https://jwlockhart.github.io/pages/about.html#about">About me</a></li>
          <li><a href="https://jwlockhart.github.io/pages/projects.html#projects">Current projects</a></li>

          <li><a href="http://www-personal.umich.edu/~jwlock/cv.pdf" target="_blank">CV</a></li>
          <li><a href="/" target="_blank">blog</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/jw_lockhart" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jwlockhart" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-google" href="https://scholar.google.com/citations?user=ptcuwrcAAAAJ" target="_blank"><i class="fa fa-google"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://jwlockhart.github.io">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="5000x">How to make your code 5000x faster, without really trying</h1>
    <p>
          Posted on Sun 24 February 2019 in <a href="https://jwlockhart.github.io/category/tips.html">tips</a>


    </p>
  </header>


  <div>
    <p>The title of this post is a bit silly, but the situation is relatively common. In most programming languages<sup id=sf-5000x-1-back><a href=#sf-5000x-1 class=simple-footnote title="Although not packages like STATA">1</a></sup>, there are multiple ways to accomplish any task, even the simple ones. These solutions are not all created equal, so if your code is slow, it really pays to test them! </p>
<p>Here's an example from my own workflow: I had messy data and needed to convert a column of <code>string</code>s to <code>int</code>s. There were a <em>lot</em> of rows to convert, and I was stuck waiting longer than the time it took me to go refresh my coffee. There are several ways to convert <code>string</code> to <code>int</code> in python/pandas, so I compared them on a small subset of my data using the <code>%timeit</code> magic in Jupiter. If you put <code>%timeit</code> at the beginning of a line of code, Jupiter will run that code multiple times and tell you how long it takes, on average.</p>
<div class=highlight><pre><span></span><span class=nf>%timeit</span> <span class=n>df</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>apply</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span>
<span class=mi>104</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>337</span> <span class=err>μ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=p>.</span> <span class=n>dev</span><span class=p>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>

<span class=nf>%timeit</span> <span class=n>pd</span><span class=p>.</span><span class=n>to_numeric</span><span class=p>(</span><span class=n>df</span><span class=p>.</span><span class=n>id</span><span class=p>,</span> <span class=n>downcast</span><span class=o>=</span><span class=err>'</span><span class=n>integer</span><span class=err>'</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=err>'</span><span class=n>coerce</span><span class=err>'</span><span class=p>)</span>
<span class=mf>2.62</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>190</span> <span class=err>μ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=p>.</span> <span class=n>dev</span><span class=p>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>100</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>

<span class=nf>%timeit</span> <span class=n>df</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>astype</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span>
<span class=mi>449</span> <span class=err>μ</span><span class=n>s</span> <span class=err>±</span> <span class=mf>3.52</span> <span class=err>μ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=p>.</span> <span class=n>dev</span><span class=p>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1000</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>

<span class=nf>%timeit</span> <span class=n>df</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>values</span><span class=p>.</span><span class=n>astype</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span>
<span class=mi>228</span> <span class=err>μ</span><span class=n>s</span> <span class=err>±</span> <span class=mf>3.12</span> <span class=err>μ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=p>.</span> <span class=n>dev</span><span class=p>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1000</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>

<span class=nf>%timeit</span> <span class=n>pd</span><span class=p>.</span><span class=n>to_numeric</span><span class=p>(</span><span class=n>df</span><span class=p>.</span><span class=n>id</span><span class=p>)</span>
<span class=mf>21.1</span> <span class=err>μ</span><span class=n>s</span> <span class=err>±</span> <span class=mi>296</span> <span class=n>ns</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=p>.</span> <span class=n>dev</span><span class=p>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10000</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</pre></div>


<p>This last method takes just 21 microseconds. It finished 4,929 times faster than the slowest approach! This is why R-user dogma insists that we should never use <code>.apply()</code> when vectorized functions (the other examples) exist to do the same job.<sup id=sf-5000x-2-back><a href=#sf-5000x-2 class=simple-footnote title='This is often misunderstood as "never use .apply() period, but not all operations can be or have been vectorized so .apply() still has its uses.'>2</a></sup> Even among the vectorized approaches, however, there is huge variance in their speed. </p>
<p><strong>So, if your code is running slow, follow these steps:</strong></p>
<ul>
<li>Use <code>%timeit</code> or similar to figure out which parts, exactly, are the slowest.<ul>
<li>Start with code that gets run many times (e.g. code inside loops or functions), since any slowness here will be compounded by repetition. </li>
</ul>
</li>
<li>Re-write those parts in other ways, and test which way is fastest.<ul>
<li>Googling <code>python fast ____</code> is a great way to get ideas for other ways to write the same code.</li>
</ul>
</li>
</ul>
<p>There are, of course, many other reasons your code may be slow, and many situations where no simple solution like this exists. But this is easy to check, and the potential returns are very high.</p>
<h2>Notes</h2><ol class=simple-footnotes><li id=sf-5000x-1>Although not packages like STATA <a href=#sf-5000x-1-back class=simple-footnote-back>↩</a></li><li id=sf-5000x-2>This is often misunderstood as "never use <code>.apply()</code> period, but not all operations can be or have been vectorized so <code>.apply()</code> still has its uses. <a href=#sf-5000x-2-back class=simple-footnote-back>↩</a></li></ol>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://jwlockhart.github.io/tag/tips.html">tips</a>
      <a href="https://jwlockhart.github.io/tag/css.html">CSS</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Jeff Lockhart ",
  "url" : "https://jwlockhart.github.io",
  "image": "/images/face.jpg",
  "description": ""
}
</script>

</body>
</html>